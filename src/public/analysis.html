<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIåˆ†æ - OKX AI åˆ†æç³»ç»Ÿ</title>
<link rel="stylesheet" href="/css/style.css">
</head>
<body>
<nav class="sidebar">
  <div class="sidebar-logo">
    <h1>ğŸ¤– OKX AI<br>åˆ†æç³»ç»Ÿ V2.0</h1>
    <p>ç°è´§æ™ºèƒ½åˆ†æå¹³å°</p>
  </div>
  <div class="nav-menu">
    <a class="nav-item" href="/"><span class="icon">ğŸ“Š</span><span>ä»ªè¡¨ç›˜</span></a>
    <a class="nav-item" href="/accounts.html"><span class="icon">ğŸ‘¤</span><span>è´¦æˆ·ç®¡ç†</span></a>
    <a class="nav-item" href="/analysis.html"><span class="icon">ğŸ§ </span><span>AIåˆ†æ</span></a>
    <a class="nav-item" href="/orders.html"><span class="icon">ğŸ“‹</span><span>äº¤æ˜“è®°å½•</span></a>
    <a class="nav-item" href="/audit.html"><span class="icon">ğŸ”</span><span>å®¡è®¡æ—¥å¿—</span></a>
    <a class="nav-item" href="/monitor.html"><span class="icon">ğŸ–¥ï¸</span><span>ç³»ç»Ÿç›‘æ§</span></a>
    <a class="nav-item" href="/settings.html"><span class="icon">âš™ï¸</span><span>ç³»ç»Ÿé…ç½®</span></a>
  </div>
  <div class="sidebar-footer">
    <button class="btn btn-sm btn-secondary" onclick="logout()">é€€å‡ºç™»å½•</button>
  </div>
</nav>

<main class="main-content">
  <div class="page-header">
    <div>
      <div class="page-title">AI åˆ†æé¢æ¿</div>
      <div class="page-subtitle">è±†åŒ… Â· Gemini Â· ChatGPT ä¸‰AIååŒåˆ†æ</div>
    </div>
    <button class="btn btn-secondary" onclick="loadLatest()">ğŸ”„ åˆ·æ–°</button>
  </div>

  <!-- æœ€æ–°åˆ†æç»“æœ -->
  <div id="latest-section">
    <div class="card"><div class="loading">åŠ è½½ä¸­...</div></div>
  </div>

  <!-- å†å²è®°å½• -->
  <div class="card" style="margin-top:16px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div class="card-title" style="margin:0;">å†å²åˆ†æè®°å½•</div>
      <div style="display:flex;gap:8px;">
        <select class="form-control" id="hist-coin" style="width:140px;" onchange="loadHistory()">
          <option value="">å…¨éƒ¨å¸ç§</option>
          <option value="BTC-USDT">BTC-USDT</option>
          <option value="ETH-USDT">ETH-USDT</option>
          <option value="SOL-USDT">SOL-USDT</option>
        </select>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>æ—¶é—´</th>
            <th>å¸ç§</th>
            <th>è±†åŒ…</th>
            <th>Gemini</th>
            <th>ChatGPT</th>
            <th>ä»²è£ç»“æœ</th>
            <th>ç½®ä¿¡åº¦</th>
            <th>å…±è¯†ç±»å‹</th>
            <th>Tokenæ¶ˆè€—</th>
            <th>æˆæœ¬($)</th>
          </tr>
        </thead>
        <tbody id="history-tbody">
          <tr><td colspan="10" class="loading">åŠ è½½ä¸­...</td></tr>
        </tbody>
      </table>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:center;">
      <button class="btn btn-sm btn-secondary" id="prev-btn" onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
      <span id="page-info" style="line-height:28px;font-size:13px;"></span>
      <button class="btn btn-sm btn-secondary" id="next-btn" onclick="changePage(1)">ä¸‹ä¸€é¡µ</button>
    </div>
  </div>
</main>

<script src="/js/app.js"></script>
<script>
let page = 1;
const pageSize = 20;
let totalPages = 1;

const aiNames = { 'AI-1': 'è±†åŒ…', 'AI-2': 'Gemini', 'AI-3': 'ChatGPT' };
const consensusLabels = { '3_unanimous': '3ç¥¨ä¸€è‡´', '2_majority': '2ç¥¨å¤šæ•°', 'diverged': 'æ„è§åˆ†æ­§' };

async function loadLatest() {
  try {
    const data = await apiFetch('/api/analysis/latest');
    if (!data) return;
    const coins = Array.isArray(data) ? data : Object.values(data);
    document.getElementById('latest-section').innerHTML = coins.map(r => `
      <div class="card" style="margin-bottom:12px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
          <div>
            <span style="font-size:16px;font-weight:700;">${r.coin}</span>
            <span class="badge ${actionBadge[r.final_action] || 'badge-gray'}" style="margin-left:10px;font-size:13px;">
              ${actionLabel[r.final_action] || r.final_action}
            </span>
            <span class="badge badge-blue" style="margin-left:6px;">${consensusLabels[r.consensus_type] || r.consensus_type}</span>
          </div>
          <div style="font-size:12px;color:var(--text-secondary);">${fmt.time(r.analysed_at)}</div>
        </div>
        <div class="grid grid-3">
          ${(r.ai_outputs || []).map(ai => `
            <div class="stat-card">
              <div class="stat-label">ğŸ¤– ${aiNames[ai.ai_id] || ai.ai_id}</div>
              <div style="margin:8px 0;">
                <span class="badge ${actionBadge[ai.analysis?.action] || 'badge-gray'}">${actionLabel[ai.analysis?.action] || ai.analysis?.action}</span>
                <span style="margin-left:8px;font-size:13px;color:var(--text-secondary);">
                  ç½®ä¿¡åº¦ ${fmt.pct(ai.analysis?.confidence)}
                </span>
              </div>
              <div style="font-size:12px;color:var(--text-secondary);">
                å»¶è¿Ÿ: ${ai.latency_ms}ms | Token: ${fmt.number(ai.tokens_used)}
              </div>
            </div>
          `).join('')}
        </div>
        <div style="margin-top:12px;display:flex;gap:16px;font-size:13px;color:var(--text-secondary);">
          <span>æ€»ç½®ä¿¡åº¦: <strong style="color:var(--text-primary);">${fmt.pct(r.final_confidence)}</strong></span>
          <span>é£é™©ç­‰çº§: <strong>${r.risk_level}</strong></span>
          <span>æ¨¡å‹æ¡£ä½: <strong>${r.model_tier === 'premium' ? 'é«˜çº§' : 'æ™®é€š'}</strong></span>
        </div>
      </div>
    `).join('') || '<div class="card"><div style="color:var(--text-secondary);text-align:center;padding:24px;">æš‚æ— åˆ†ææ•°æ®</div></div>';
  } catch(e) {
    document.getElementById('latest-section').innerHTML = `<div class="card"><div style="color:var(--accent-red);">åŠ è½½å¤±è´¥: ${e.message}</div></div>`;
  }
}

async function loadHistory() {
  const coin = document.getElementById('hist-coin').value;
  try {
    const params = new URLSearchParams({ page, pageSize });
    if (coin) params.append('coin', coin);
    const data = await apiFetch('/api/analysis/history?' + params);
    if (!data) return;
    const items = data.items || data || [];
    totalPages = data.totalPages || Math.ceil((data.total || items.length) / pageSize) || 1;
    document.getElementById('page-info').textContent = `ç¬¬ ${page}/${totalPages} é¡µ`;
    document.getElementById('prev-btn').disabled = page <= 1;
    document.getElementById('next-btn').disabled = page >= totalPages;
    if (!items.length) {
      document.getElementById('history-tbody').innerHTML = '<tr><td colspan="10" style="text-align:center;color:var(--text-secondary);padding:24px;">æš‚æ— å†å²è®°å½•</td></tr>';
      return;
    }
    document.getElementById('history-tbody').innerHTML = items.map(r => {
      const ai1 = (r.ai_outputs || []).find(a => a.ai_id === 'AI-1');
      const ai2 = (r.ai_outputs || []).find(a => a.ai_id === 'AI-2');
      const ai3 = (r.ai_outputs || []).find(a => a.ai_id === 'AI-3');
      const totalTokens = (r.ai_outputs || []).reduce((s, a) => s + (a.tokens_used || 0), 0);
      const totalCost = (r.ai_outputs || []).reduce((s, a) => s + (a.estimated_cost || 0), 0);
      return `<tr>
        <td>${fmt.time(r.analysed_at)}</td>
        <td>${r.coin}</td>
        <td><span class="badge ${actionBadge[ai1?.analysis?.action] || 'badge-gray'}">${actionLabel[ai1?.analysis?.action] || '--'}</span></td>
        <td><span class="badge ${actionBadge[ai2?.analysis?.action] || 'badge-gray'}">${actionLabel[ai2?.analysis?.action] || '--'}</span></td>
        <td><span class="badge ${actionBadge[ai3?.analysis?.action] || 'badge-gray'}">${actionLabel[ai3?.analysis?.action] || '--'}</span></td>
        <td><span class="badge ${actionBadge[r.final_action] || 'badge-gray'}">${actionLabel[r.final_action] || r.final_action}</span></td>
        <td>${fmt.pct(r.final_confidence)}</td>
        <td>${consensusLabels[r.consensus_type] || r.consensus_type || '--'}</td>
        <td>${fmt.number(totalTokens)}</td>
        <td>$${totalCost.toFixed(5)}</td>
      </tr>`;
    }).join('');
  } catch(e) {
    document.getElementById('history-tbody').innerHTML = `<tr><td colspan="10" style="color:var(--accent-red);">åŠ è½½å¤±è´¥: ${e.message}</td></tr>`;
  }
}

function changePage(delta) {
  page = Math.max(1, Math.min(totalPages, page + delta));
  loadHistory();
}

loadLatest();
loadHistory();
setInterval(loadLatest, 60000);
</script>
</body>
</html>
