<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å®¡è®¡æ—¥å¿— - OKX AI åˆ†æç³»ç»Ÿ</title>
<link rel="stylesheet" href="/css/style.css">
</head>
<body>
<nav class="sidebar">
  <div class="sidebar-logo">
    <h1>ğŸ¤– OKX AI<br>åˆ†æç³»ç»Ÿ V2.0</h1>
    <p>ç°è´§æ™ºèƒ½åˆ†æå¹³å°</p>
  </div>
  <div class="nav-menu">
    <a class="nav-item" href="/"><span class="icon">ğŸ“Š</span><span>ä»ªè¡¨ç›˜</span></a>
    <a class="nav-item" href="/accounts.html"><span class="icon">ğŸ‘¤</span><span>è´¦æˆ·ç®¡ç†</span></a>
    <a class="nav-item" href="/analysis.html"><span class="icon">ğŸ§ </span><span>AIåˆ†æ</span></a>
    <a class="nav-item" href="/orders.html"><span class="icon">ğŸ“‹</span><span>äº¤æ˜“è®°å½•</span></a>
    <a class="nav-item" href="/audit.html"><span class="icon">ğŸ”</span><span>å®¡è®¡æ—¥å¿—</span></a>
    <a class="nav-item" href="/monitor.html"><span class="icon">ğŸ–¥ï¸</span><span>ç³»ç»Ÿç›‘æ§</span></a>
    <a class="nav-item" href="/settings.html"><span class="icon">âš™ï¸</span><span>ç³»ç»Ÿé…ç½®</span></a>
  </div>
  <div class="sidebar-footer">
    <button class="btn btn-sm btn-secondary" onclick="logout()">é€€å‡ºç™»å½•</button>
  </div>
</nav>

<main class="main-content">
  <div class="page-header">
    <div>
      <div class="page-title">å®¡è®¡æ—¥å¿—</div>
      <div class="page-subtitle">å…¨é‡æ“ä½œæ—¥å¿—ï¼Œå“ˆå¸Œé“¾éªŒè¯</div>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-secondary" onclick="verifyChain()">ğŸ” éªŒè¯å“ˆå¸Œé“¾</button>
      <button class="btn btn-secondary" onclick="loadAudit()">ğŸ”„ åˆ·æ–°</button>
    </div>
  </div>

  <div id="chain-status" style="display:none;margin-bottom:16px;"></div>

  <div class="card">
    <!-- ç­›é€‰æ  -->
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
      <input type="date" class="form-control" id="filter-from" style="width:150px;" onchange="loadAudit()">
      <input type="date" class="form-control" id="filter-to" style="width:150px;" onchange="loadAudit()">
      <select class="form-control" id="filter-coin" style="width:140px;" onchange="loadAudit()">
        <option value="">å…¨éƒ¨å¸ç§</option>
        <option value="BTC-USDT">BTC-USDT</option>
        <option value="ETH-USDT">ETH-USDT</option>
        <option value="SOL-USDT">SOL-USDT</option>
      </select>
      <select class="form-control" id="filter-event" style="width:160px;" onchange="loadAudit()">
        <option value="">å…¨éƒ¨äº‹ä»¶</option>
        <option value="ai_analysis">AIåˆ†æ</option>
        <option value="order_placed">ä¸‹å•</option>
        <option value="order_filled">æˆäº¤</option>
        <option value="risk_triggered">é£æ§è§¦å‘</option>
        <option value="system_mode_change">ç³»ç»Ÿæ¨¡å¼å˜æ›´</option>
      </select>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>åºå·</th>
            <th>æ—¶é—´</th>
            <th>äº‹ä»¶ç±»å‹</th>
            <th>å¸ç§</th>
            <th>æ‘˜è¦</th>
            <th>å“ˆå¸Œ</th>
          </tr>
        </thead>
        <tbody id="audit-tbody">
          <tr><td colspan="6" class="loading">åŠ è½½ä¸­...</td></tr>
        </tbody>
      </table>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:center;">
      <button class="btn btn-sm btn-secondary" id="prev-btn" onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
      <span id="page-info" style="line-height:28px;font-size:13px;"></span>
      <button class="btn btn-sm btn-secondary" id="next-btn" onclick="changePage(1)">ä¸‹ä¸€é¡µ</button>
    </div>
  </div>
</main>

<script src="/js/app.js"></script>
<script>
let page = 1;
const pageSize = 50;
let totalPages = 1;

const eventLabels = {
  ai_analysis: 'AIåˆ†æ',
  order_placed: 'ä¸‹å•',
  order_filled: 'æˆäº¤',
  risk_triggered: 'é£æ§è§¦å‘',
  system_mode_change: 'ç³»ç»Ÿæ¨¡å¼å˜æ›´',
  account_added: 'æ·»åŠ è´¦æˆ·',
  account_deactivated: 'åœç”¨è´¦æˆ·',
};

async function loadAudit() {
  const from = document.getElementById('filter-from').value;
  const to = document.getElementById('filter-to').value;
  const coin = document.getElementById('filter-coin').value;
  const event = document.getElementById('filter-event').value;
  try {
    const params = new URLSearchParams({ page, pageSize });
    if (from) params.append('from', from);
    if (to) params.append('to', to);
    if (coin) params.append('coin', coin);
    if (event) params.append('event', event);
    const data = await apiFetch('/api/audit?' + params);
    if (!data) return;
    const items = data.items || data || [];
    totalPages = data.totalPages || Math.ceil((data.total || items.length) / pageSize) || 1;
    document.getElementById('page-info').textContent = `ç¬¬ ${page}/${totalPages} é¡µï¼Œå…± ${data.total || items.length} æ¡`;
    document.getElementById('prev-btn').disabled = page <= 1;
    document.getElementById('next-btn').disabled = page >= totalPages;
    if (!items.length) {
      document.getElementById('audit-tbody').innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-secondary);padding:24px;">æš‚æ— æ—¥å¿—</td></tr>';
      return;
    }
    document.getElementById('audit-tbody').innerHTML = items.map(a => `<tr>
      <td style="color:var(--text-secondary);">${a.sequence_number || a.id?.slice(0,8)}</td>
      <td>${fmt.time(a.timestamp)}</td>
      <td><span class="badge badge-blue">${eventLabels[a.event_type] || a.event_type}</span></td>
      <td>${a.coin || '--'}</td>
      <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${a.summary || JSON.stringify(a.payload || {}).slice(0, 60)}</td>
      <td style="font-family:monospace;font-size:11px;color:var(--text-secondary);">${(a.hash || '').slice(0, 16)}...</td>
    </tr>`).join('');
  } catch(e) {
    document.getElementById('audit-tbody').innerHTML = `<tr><td colspan="6" style="color:var(--accent-red);">åŠ è½½å¤±è´¥: ${e.message}</td></tr>`;
  }
}

async function verifyChain() {
  const el = document.getElementById('chain-status');
  el.style.display = 'block';
  el.innerHTML = '<div class="card" style="padding:12px;color:var(--text-secondary);">éªŒè¯ä¸­...</div>';
  try {
    const data = await apiFetch('/api/audit/verify');
    if (!data) return;
    const ok = data.valid || data.isValid;
    el.innerHTML = `<div class="card" style="padding:12px;border-left:4px solid ${ok ? 'var(--accent-green)' : 'var(--accent-red)'};">
      ${ok ? 'âœ… å“ˆå¸Œé“¾å®Œæ•´ï¼Œæœªæ£€æµ‹åˆ°ç¯¡æ”¹' : `âŒ å“ˆå¸Œé“¾éªŒè¯å¤±è´¥: ${data.error || 'æ•°æ®å¼‚å¸¸'}`}
    </div>`;
  } catch(e) {
    el.innerHTML = `<div class="card" style="padding:12px;border-left:4px solid var(--accent-red);">âŒ éªŒè¯å¤±è´¥: ${e.message}</div>`;
  }
}

function changePage(delta) {
  page = Math.max(1, Math.min(totalPages, page + delta));
  loadAudit();
}

loadAudit();
</script>
</body>
</html>
