<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è´¦æˆ·ç®¡ç† - OKX AI åˆ†æç³»ç»Ÿ</title>
<link rel="stylesheet" href="/css/style.css">
</head>
<body>
<nav class="sidebar">
  <div class="sidebar-logo">
    <h1>ğŸ¤– OKX AI<br>åˆ†æç³»ç»Ÿ V2.0</h1>
    <p>ç°è´§æ™ºèƒ½åˆ†æå¹³å°</p>
  </div>
  <div class="nav-menu">
    <a class="nav-item" href="/"><span class="icon">ğŸ“Š</span><span>ä»ªè¡¨ç›˜</span></a>
    <a class="nav-item" href="/accounts.html"><span class="icon">ğŸ‘¤</span><span>è´¦æˆ·ç®¡ç†</span></a>
    <a class="nav-item" href="/analysis.html"><span class="icon">ğŸ§ </span><span>AIåˆ†æ</span></a>
    <a class="nav-item" href="/orders.html"><span class="icon">ğŸ“‹</span><span>äº¤æ˜“è®°å½•</span></a>
    <a class="nav-item" href="/audit.html"><span class="icon">ğŸ”</span><span>å®¡è®¡æ—¥å¿—</span></a>
    <a class="nav-item" href="/monitor.html"><span class="icon">ğŸ–¥ï¸</span><span>ç³»ç»Ÿç›‘æ§</span></a>
    <a class="nav-item" href="/settings.html"><span class="icon">âš™ï¸</span><span>ç³»ç»Ÿé…ç½®</span></a>
  </div>
  <div class="sidebar-footer">
    <button class="btn btn-sm btn-secondary" onclick="logout()">é€€å‡ºç™»å½•</button>
  </div>
</nav>

<main class="main-content">
  <div class="page-header">
    <div>
      <div class="page-title">å¤šè´¦æˆ·ç®¡ç†</div>
      <div class="page-subtitle">ç®¡ç† OKX äº¤æ˜“è´¦æˆ·åŠæƒé™</div>
    </div>
    <button class="btn btn-primary" onclick="showAddModal()">ï¼‹ æ·»åŠ è´¦æˆ·</button>
  </div>

  <!-- è´¦æˆ·åˆ—è¡¨ -->
  <div class="card">
    <div class="card-title">è´¦æˆ·åˆ—è¡¨</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>è´¦æˆ·åç§°</th>
            <th>çŠ¶æ€</th>
            <th>åˆ›å»ºæ—¶é—´</th>
            <th>ä½™é¢ (USDT)</th>
            <th>æƒé™è®¾ç½®</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="accounts-tbody">
          <tr><td colspan="6" class="loading">åŠ è½½ä¸­...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</main>

<!-- æ·»åŠ è´¦æˆ·å¼¹çª— -->
<div class="modal-overlay" id="add-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">æ·»åŠ  OKX è´¦æˆ·</div>
      <button class="modal-close" onclick="closeModal('add-modal')">âœ•</button>
    </div>
    <div class="form-group">
      <label class="form-label">è´¦æˆ·åç§° *</label>
      <input class="form-control" id="acc-name" placeholder="ä¾‹å¦‚: ä¸»è´¦æˆ·">
    </div>
    <div class="form-group">
      <label class="form-label">API Key *</label>
      <input class="form-control" id="acc-key" placeholder="OKX API Key">
    </div>
    <div class="form-group">
      <label class="form-label">API Secret *</label>
      <input class="form-control" type="password" id="acc-secret" placeholder="OKX API Secret">
    </div>
    <div class="form-group">
      <label class="form-label">Passphrase *</label>
      <input class="form-control" type="password" id="acc-pass" placeholder="OKX API Passphrase">
    </div>
    <div id="add-err" style="color:var(--accent-red);font-size:13px;margin-bottom:12px;display:none;"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button class="btn btn-secondary" onclick="closeModal('add-modal')">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="addAccount()">ç¡®è®¤æ·»åŠ </button>
    </div>
  </div>
</div>

<!-- æƒé™è®¾ç½®å¼¹çª— -->
<div class="modal-overlay" id="perm-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">æƒé™è®¾ç½®</div>
      <button class="modal-close" onclick="closeModal('perm-modal')">âœ•</button>
    </div>
    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">ä¸ºè´¦æˆ· <strong id="perm-acc-name"></strong> è®¾ç½®å„å¸ç§æ“ä½œæƒé™</p>
    <div id="perm-content"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
      <button class="btn btn-secondary" onclick="closeModal('perm-modal')">å…³é—­</button>
      <button class="btn btn-primary" onclick="savePermissions()">ä¿å­˜æƒé™</button>
    </div>
  </div>
</div>

<script src="/js/app.js"></script>
<script>
let currentPermAccId = null;

const permLabels = {
  observe: 'ä»…è§‚å¯Ÿ',
  notify_only: 'ä»…é€šçŸ¥',
  auto_buy: 'è‡ªåŠ¨ä¹°å…¥',
  auto_sell: 'è‡ªåŠ¨å–å‡º',
  auto_both: 'è‡ªåŠ¨ä¹°å–',
};

async function loadAccounts() {
  try {
    const accounts = await apiFetch('/api/accounts');
    if (!accounts) return;
    if (!accounts.length) {
      document.getElementById('accounts-tbody').innerHTML =
        '<tr><td colspan="6" style="text-align:center;color:var(--text-secondary);padding:24px;">æš‚æ— è´¦æˆ·ï¼Œè¯·ç‚¹å‡»"æ·»åŠ è´¦æˆ·"</td></tr>';
      return;
    }
    document.getElementById('accounts-tbody').innerHTML = accounts.map(a => `
      <tr>
        <td><strong>${a.name}</strong></td>
        <td>${statusBadge(a.status || 'active')}</td>
        <td>${fmt.time(a.created_at || a.createdAt)}</td>
        <td id="bal-${a.id}">--</td>
        <td>
          <button class="btn btn-sm btn-secondary" onclick="showPermModal('${a.id}','${a.name}')">è®¾ç½®æƒé™</button>
        </td>
        <td>
          <button class="btn btn-sm btn-danger" onclick="deactivateAccount('${a.id}')">åœç”¨</button>
        </td>
      </tr>
    `).join('');
    // åŠ è½½ä½™é¢
    accounts.forEach(a => loadBalance(a.id));
  } catch(e) {
    document.getElementById('accounts-tbody').innerHTML = `<tr><td colspan="6" style="color:var(--accent-red);">åŠ è½½å¤±è´¥: ${e.message}</td></tr>`;
  }
}

async function loadBalance(id) {
  try {
    const data = await apiFetch(`/api/accounts/${id}/balance`);
    if (data) document.getElementById('bal-' + id).textContent = fmt.price(data.usdt);
  } catch {}
}

function showAddModal() {
  document.getElementById('add-modal').classList.add('show');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('show');
}

async function addAccount() {
  const name = document.getElementById('acc-name').value.trim();
  const apiKey = document.getElementById('acc-key').value.trim();
  const apiSecret = document.getElementById('acc-secret').value.trim();
  const passphrase = document.getElementById('acc-pass').value.trim();
  const errEl = document.getElementById('add-err');
  if (!name || !apiKey || !apiSecret || !passphrase) {
    errEl.textContent = 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ'; errEl.style.display = 'block'; return;
  }
  try {
    await apiFetch('/api/accounts', { method: 'POST', body: JSON.stringify({ name, apiKey, apiSecret, passphrase }) });
    closeModal('add-modal');
    loadAccounts();
    ['acc-name','acc-key','acc-secret','acc-pass'].forEach(id => document.getElementById(id).value = '');
  } catch(e) {
    errEl.textContent = 'æ·»åŠ å¤±è´¥: ' + e.message; errEl.style.display = 'block';
  }
}

async function deactivateAccount(id) {
  if (!confirm('ç¡®å®šè¦åœç”¨è¯¥è´¦æˆ·å—ï¼Ÿ')) return;
  try {
    await apiFetch(`/api/accounts/${id}`, { method: 'DELETE' });
    loadAccounts();
  } catch(e) { alert('åœç”¨å¤±è´¥: ' + e.message); }
}

function showPermModal(id, name) {
  currentPermAccId = id;
  document.getElementById('perm-acc-name').textContent = name;
  const coins = ['BTC-USDT', 'ETH-USDT', 'SOL-USDT'];
  document.getElementById('perm-content').innerHTML = coins.map(coin => `
    <div class="form-group">
      <label class="form-label">${coin}</label>
      <select class="form-control" id="perm-${coin}">
        ${Object.entries(permLabels).map(([k,v]) => `<option value="${k}">${v}</option>`).join('')}
      </select>
    </div>
  `).join('');
  document.getElementById('perm-modal').classList.add('show');
}

async function savePermissions() {
  const coins = ['BTC-USDT', 'ETH-USDT', 'SOL-USDT'];
  const permissions = {};
  coins.forEach(c => { permissions[c] = document.getElementById('perm-' + c).value; });
  try {
    await apiFetch(`/api/accounts/${currentPermAccId}/permissions`, {
      method: 'POST',
      body: JSON.stringify({ permissions }),
    });
    closeModal('perm-modal');
    alert('æƒé™ä¿å­˜æˆåŠŸ');
  } catch(e) { alert('ä¿å­˜å¤±è´¥: ' + e.message); }
}

loadAccounts();
</script>
</body>
</html>
