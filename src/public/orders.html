<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>äº¤æ˜“è®°å½• - OKX AI åˆ†æç³»ç»Ÿ</title>
<link rel="stylesheet" href="/css/style.css">
</head>
<body>
<nav class="sidebar">
  <div class="sidebar-logo">
    <h1>ğŸ¤– OKX AI<br>åˆ†æç³»ç»Ÿ V2.0</h1>
    <p>ç°è´§æ™ºèƒ½åˆ†æå¹³å°</p>
  </div>
  <div class="nav-menu">
    <a class="nav-item" href="/"><span class="icon">ğŸ“Š</span><span>ä»ªè¡¨ç›˜</span></a>
    <a class="nav-item" href="/accounts.html"><span class="icon">ğŸ‘¤</span><span>è´¦æˆ·ç®¡ç†</span></a>
    <a class="nav-item" href="/analysis.html"><span class="icon">ğŸ§ </span><span>AIåˆ†æ</span></a>
    <a class="nav-item" href="/orders.html"><span class="icon">ğŸ“‹</span><span>äº¤æ˜“è®°å½•</span></a>
    <a class="nav-item" href="/audit.html"><span class="icon">ğŸ”</span><span>å®¡è®¡æ—¥å¿—</span></a>
    <a class="nav-item" href="/monitor.html"><span class="icon">ğŸ–¥ï¸</span><span>ç³»ç»Ÿç›‘æ§</span></a>
    <a class="nav-item" href="/settings.html"><span class="icon">âš™ï¸</span><span>ç³»ç»Ÿé…ç½®</span></a>
  </div>
  <div class="sidebar-footer">
    <button class="btn btn-sm btn-secondary" onclick="logout()">é€€å‡ºç™»å½•</button>
  </div>
</nav>

<main class="main-content">
  <div class="page-header">
    <div>
      <div class="page-title">äº¤æ˜“è®°å½•</div>
      <div class="page-subtitle">AI è‡ªåŠ¨ä¸‹å•å†å²</div>
    </div>
    <button class="btn btn-secondary" onclick="loadOrders()">ğŸ”„ åˆ·æ–°</button>
  </div>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <div class="grid grid-4" id="stats-row" style="margin-bottom:16px;">
    <div class="stat-card"><div class="stat-label">æ€»è®¢å•æ•°</div><div class="stat-value" id="s-total">--</div></div>
    <div class="stat-card"><div class="stat-label">å·²æˆäº¤</div><div class="stat-value" style="color:var(--accent-green)" id="s-filled">--</div></div>
    <div class="stat-card"><div class="stat-label">å¤±è´¥è®¢å•</div><div class="stat-value" style="color:var(--accent-red)" id="s-failed">--</div></div>
    <div class="stat-card"><div class="stat-label">æˆåŠŸç‡</div><div class="stat-value" id="s-rate">--</div></div>
  </div>

  <div class="card">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
      <select class="form-control" id="filter-status" style="width:140px;" onchange="loadOrders()">
        <option value="">å…¨éƒ¨çŠ¶æ€</option>
        <option value="pending">å¾…æ‰§è¡Œ</option>
        <option value="filled">å·²æˆäº¤</option>
        <option value="cancelled">å·²å–æ¶ˆ</option>
        <option value="failed">å¤±è´¥</option>
      </select>
      <select class="form-control" id="filter-coin" style="width:140px;" onchange="loadOrders()">
        <option value="">å…¨éƒ¨å¸ç§</option>
        <option value="BTC-USDT">BTC-USDT</option>
        <option value="ETH-USDT">ETH-USDT</option>
        <option value="SOL-USDT">SOL-USDT</option>
      </select>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>æ—¶é—´</th>
            <th>å¸ç§</th>
            <th>æ–¹å‘</th>
            <th>æ•°é‡</th>
            <th>ä»·æ ¼</th>
            <th>æ»‘ç‚¹</th>
            <th>çŠ¶æ€</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="orders-tbody">
          <tr><td colspan="8" class="loading">åŠ è½½ä¸­...</td></tr>
        </tbody>
      </table>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:center;">
      <button class="btn btn-sm btn-secondary" id="prev-btn" onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
      <span id="page-info" style="line-height:28px;font-size:13px;"></span>
      <button class="btn btn-sm btn-secondary" id="next-btn" onclick="changePage(1)">ä¸‹ä¸€é¡µ</button>
    </div>
  </div>
</main>

<!-- è®¢å•è¯¦æƒ…å¼¹çª— -->
<div class="modal-overlay" id="detail-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">è®¢å•è¯¦æƒ…</div>
      <button class="modal-close" onclick="document.getElementById('detail-modal').classList.remove('show')">âœ•</button>
    </div>
    <div id="detail-content"></div>
  </div>
</div>

<script src="/js/app.js"></script>
<script>
let page = 1;
const pageSize = 20;
let totalPages = 1;

async function loadStats() {
  try {
    const data = await apiFetch('/api/orders/stats');
    if (!data) return;
    document.getElementById('s-total').textContent = fmt.number(data.total || 0);
    document.getElementById('s-filled').textContent = fmt.number(data.filled || 0);
    document.getElementById('s-failed').textContent = fmt.number(data.failed || 0);
    const rate = data.total ? ((data.filled || 0) / data.total) : 0;
    document.getElementById('s-rate').textContent = fmt.pct(rate);
  } catch {}
}

async function loadOrders() {
  const status = document.getElementById('filter-status').value;
  const coin = document.getElementById('filter-coin').value;
  try {
    const params = new URLSearchParams({ page, pageSize });
    if (status) params.append('status', status);
    if (coin) params.append('coin', coin);
    const data = await apiFetch('/api/orders?' + params);
    if (!data) return;
    const items = data.items || data || [];
    totalPages = data.totalPages || Math.ceil((data.total || items.length) / pageSize) || 1;
    document.getElementById('page-info').textContent = `ç¬¬ ${page}/${totalPages} é¡µ`;
    document.getElementById('prev-btn').disabled = page <= 1;
    document.getElementById('next-btn').disabled = page >= totalPages;
    if (!items.length) {
      document.getElementById('orders-tbody').innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-secondary);padding:24px;">æš‚æ— äº¤æ˜“è®°å½•</td></tr>';
      return;
    }
    document.getElementById('orders-tbody').innerHTML = items.map(o => `<tr>
      <td>${fmt.time(o.created_at || o.createdAt)}</td>
      <td>${o.coin || o.symbol}</td>
      <td>${statusBadge(o.side || o.direction)}</td>
      <td>${o.size || o.quantity || '--'}</td>
      <td>${fmt.price(o.price)}</td>
      <td>${o.slippage_bps != null ? o.slippage_bps + ' bps' : '--'}</td>
      <td>${statusBadge(o.status)}</td>
      <td><button class="btn btn-sm btn-secondary" onclick="showDetail(${JSON.stringify(o).replace(/"/g,'&quot;')})">è¯¦æƒ…</button></td>
    </tr>`).join('');
  } catch(e) {
    document.getElementById('orders-tbody').innerHTML = `<tr><td colspan="8" style="color:var(--accent-red);">åŠ è½½å¤±è´¥: ${e.message}</td></tr>`;
  }
}

function showDetail(o) {
  document.getElementById('detail-content').innerHTML = `
    <div style="display:grid;gap:8px;font-size:13px;">
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);">
        <span style="color:var(--text-secondary);">è®¢å•ID</span><span>${o.id}</span>
      </div>
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);">
        <span style="color:var(--text-secondary);">å¸ç§</span><span>${o.coin || o.symbol}</span>
      </div>
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);">
        <span style="color:var(--text-secondary);">æ–¹å‘</span><span>${statusBadge(o.side || o.direction)}</span>
      </div>
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);">
        <span style="color:var(--text-secondary);">ä»·æ ¼</span><span>${fmt.price(o.price)}</span>
      </div>
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);">
        <span style="color:var(--text-secondary);">æ•°é‡</span><span>${o.size || o.quantity}</span>
      </div>
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);">
        <span style="color:var(--text-secondary);">çŠ¶æ€</span><span>${statusBadge(o.status)}</span>
      </div>
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);">
        <span style="color:var(--text-secondary);">æ»‘ç‚¹</span><span>${o.slippage_bps != null ? o.slippage_bps + ' bps' : '--'}</span>
      </div>
      <div style="display:flex;justify-content:space-between;padding:8px 0;">
        <span style="color:var(--text-secondary);">æ—¶é—´</span><span>${fmt.time(o.created_at || o.createdAt)}</span>
      </div>
    </div>`;
  document.getElementById('detail-modal').classList.add('show');
}

function changePage(delta) {
  page = Math.max(1, Math.min(totalPages, page + delta));
  loadOrders();
}

loadStats();
loadOrders();
</script>
</body>
</html>
