<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç³»ç»Ÿç›‘æ§ - OKX AI åˆ†æç³»ç»Ÿ</title>
<link rel="stylesheet" href="/css/style.css">
</head>
<body>
<nav class="sidebar">
  <div class="sidebar-logo">
    <h1>ğŸ¤– OKX AI<br>åˆ†æç³»ç»Ÿ V2.0</h1>
    <p>ç°è´§æ™ºèƒ½åˆ†æå¹³å°</p>
  </div>
  <div class="nav-menu">
    <a class="nav-item" href="/"><span class="icon">ğŸ“Š</span><span>ä»ªè¡¨ç›˜</span></a>
    <a class="nav-item" href="/accounts.html"><span class="icon">ğŸ‘¤</span><span>è´¦æˆ·ç®¡ç†</span></a>
    <a class="nav-item" href="/analysis.html"><span class="icon">ğŸ§ </span><span>AIåˆ†æ</span></a>
    <a class="nav-item" href="/orders.html"><span class="icon">ğŸ“‹</span><span>äº¤æ˜“è®°å½•</span></a>
    <a class="nav-item" href="/audit.html"><span class="icon">ğŸ”</span><span>å®¡è®¡æ—¥å¿—</span></a>
    <a class="nav-item" href="/monitor.html"><span class="icon">ğŸ–¥ï¸</span><span>ç³»ç»Ÿç›‘æ§</span></a>
    <a class="nav-item" href="/settings.html"><span class="icon">âš™ï¸</span><span>ç³»ç»Ÿé…ç½®</span></a>
  </div>
  <div class="sidebar-footer">
    <button class="btn btn-sm btn-secondary" onclick="logout()">é€€å‡ºç™»å½•</button>
  </div>
</nav>

<main class="main-content">
  <div class="page-header">
    <div>
      <div class="page-title">ç³»ç»Ÿç›‘æ§</div>
      <div class="page-subtitle">APIå¥åº·çŠ¶æ€ Â· AIæœåŠ¡ Â· æ•°æ®æº</div>
    </div>
    <button class="btn btn-secondary" onclick="loadMonitor()">ğŸ”„ åˆ·æ–°</button>
  </div>

  <div class="grid grid-2">
    <!-- OKX API çŠ¶æ€ -->
    <div class="card">
      <div class="card-title">OKX API çŠ¶æ€</div>
      <div id="okx-status"><div class="loading">åŠ è½½ä¸­...</div></div>
    </div>

    <!-- AI æœåŠ¡çŠ¶æ€ -->
    <div class="card">
      <div class="card-title">AI æœåŠ¡çŠ¶æ€</div>
      <div id="ai-status"><div class="loading">åŠ è½½ä¸­...</div></div>
    </div>
  </div>

  <div class="grid grid-2">
    <!-- å·¨é²¸æ•°æ®æº -->
    <div class="card">
      <div class="card-title">ğŸ‹ å·¨é²¸æ•°æ®æº</div>
      <div id="whale-status"><div class="loading">åŠ è½½ä¸­...</div></div>
    </div>

    <!-- æ•°æ®åº“/ç¼“å­˜ -->
    <div class="card">
      <div class="card-title">æ•°æ®åº“ / ç¼“å­˜</div>
      <div id="db-status"><div class="loading">åŠ è½½ä¸­...</div></div>
    </div>
  </div>

  <!-- ç³»ç»Ÿé™çº§çŠ¶æ€ -->
  <div class="card">
    <div class="card-title">ç³»ç»Ÿé™çº§çŠ¶æ€</div>
    <div id="degradation-status"><div class="loading">åŠ è½½ä¸­...</div></div>
  </div>
</main>

<script src="/js/app.js"></script>
<script>
function latencyBadge(ms) {
  if (ms == null) return '<span class="badge badge-gray">--</span>';
  if (ms < 100) return `<span class="badge badge-green">${ms}ms</span>`;
  if (ms < 500) return `<span class="badge badge-yellow">${ms}ms</span>`;
  return `<span class="badge badge-red">${ms}ms</span>`;
}

function boolBadge(v, trueLabel = 'æ­£å¸¸', falseLabel = 'å¼‚å¸¸') {
  return v
    ? `<span class="badge badge-green"><span class="status-dot online"></span>${trueLabel}</span>`
    : `<span class="badge badge-red"><span class="status-dot offline"></span>${falseLabel}</span>`;
}

async function loadMonitor() {
  try {
    const data = await apiFetch('/api/monitor/status');
    if (!data) return;

    // OKX API
    const okx = data.okx || {};
    document.getElementById('okx-status').innerHTML = `
      <div style="display:grid;gap:8px;">
        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);">
          <span>WebSocket è¿æ¥</span>${boolBadge(okx.ws_connected)}
        </div>
        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);">
          <span>WS å»¶è¿Ÿ</span>${latencyBadge(okx.ws_latency_ms)}
        </div>
        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);">
          <span>REST API å»¶è¿Ÿ</span>${latencyBadge(okx.rest_latency_ms)}
        </div>
        <div style="display:flex;justify-content:space-between;padding:8px 0;">
          <span>é”™è¯¯ç‡</span>
          <span class="${(okx.error_rate || 0) > 5 ? 'badge badge-red' : 'badge badge-green'}">${((okx.error_rate || 0)).toFixed(1)}%</span>
        </div>
      </div>`;

    // AI æœåŠ¡
    const ai = data.ai || {};
    const aiMap = [
      { id: 'AI-1', name: 'è±†åŒ… (Doubao)', data: ai['AI-1'] || {} },
      { id: 'AI-2', name: 'Gemini', data: ai['AI-2'] || {} },
      { id: 'AI-3', name: 'ChatGPT', data: ai['AI-3'] || {} },
    ];
    document.getElementById('ai-status').innerHTML = aiMap.map(a => `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border-color);">
        <span>ğŸ¤– ${a.name}</span>
        <div style="display:flex;align-items:center;gap:8px;">
          ${latencyBadge(a.data.latency_ms)}
          ${boolBadge(a.data.available !== false)}
        </div>
      </div>
    `).join('');

    // å·¨é²¸æ•°æ®æº
    const whale = data.whale || {};
    document.getElementById('whale-status').innerHTML = `
      <div style="display:grid;gap:8px;">
        ${['arkham', 'glassnode', 'whale_alert', 'dune'].map(src => `
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);">
            <span>${src.replace('_', ' ').toUpperCase()}</span>
            ${boolBadge(whale[src]?.available, 'å¯ç”¨', 'ä¸å¯ç”¨/æœªé…ç½®')}
          </div>
        `).join('')}
        <div style="display:flex;justify-content:space-between;padding:8px 0;">
          <span>æ•°æ®æ–°é²œåº¦</span>
          <span>${whale.freshness_seconds != null ? whale.freshness_seconds + 'ç§’å‰' : '--'}</span>
        </div>
      </div>`;

    // æ•°æ®åº“
    const db = data.database || {};
    document.getElementById('db-status').innerHTML = `
      <div style="display:grid;gap:8px;">
        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);">
          <span>PostgreSQL</span>${boolBadge(db.postgres)}
        </div>
        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-color);">
          <span>Redis</span>${boolBadge(db.redis)}
        </div>
        <div style="display:flex;justify-content:space-between;padding:8px 0;">
          <span>DB å»¶è¿Ÿ</span>${latencyBadge(db.latency_ms)}
        </div>
      </div>`;

    // é™çº§çŠ¶æ€
    const deg = data.degradation || {};
    document.getElementById('degradation-status').innerHTML = `
      <div class="grid grid-4">
        <div class="stat-card">
          <div class="stat-label">å½“å‰æ¨¡å¼</div>
          <div style="margin-top:8px;">${boolBadge(deg.mode === 'normal', 'æ­£å¸¸', deg.mode === 'degraded' ? 'é™çº§è¿è¡Œ' : 'ç´§æ€¥åœæ­¢')}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æš‚åœäº¤æ˜“</div>
          <div style="margin-top:8px;">${boolBadge(!deg.trading_paused, 'è¿è¡Œä¸­', 'å·²æš‚åœ')}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ä½¿ç”¨ç¼“å­˜AI</div>
          <div style="margin-top:8px;">${deg.using_cached_ai ? '<span class="badge badge-yellow">æ˜¯</span>' : '<span class="badge badge-green">å¦</span>'}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">é™çº§åŸå› </div>
          <div style="margin-top:8px;font-size:12px;color:var(--text-secondary);">${deg.reason || '--'}</div>
        </div>
      </div>`;
  } catch(e) {
    console.error('Monitor load error:', e);
  }
}

loadMonitor();
setInterval(loadMonitor, 30000);
</script>
</body>
</html>
