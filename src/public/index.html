<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä»ªè¡¨ç›˜ - OKX AI åˆ†æç³»ç»Ÿ</title>
<link rel="stylesheet" href="/css/style.css">
</head>
<body>
<!-- å·¦ä¾§å¯¼èˆª -->
<nav class="sidebar">
  <div class="sidebar-logo">
    <h1>ğŸ¤– OKX AI<br>åˆ†æç³»ç»Ÿ V2.0</h1>
    <p>ç°è´§æ™ºèƒ½åˆ†æå¹³å°</p>
  </div>
  <div class="nav-menu">
    <a class="nav-item" href="/"><span class="icon">ğŸ“Š</span><span>ä»ªè¡¨ç›˜</span></a>
    <a class="nav-item" href="/accounts.html"><span class="icon">ğŸ‘¤</span><span>è´¦æˆ·ç®¡ç†</span></a>
    <a class="nav-item" href="/analysis.html"><span class="icon">ğŸ§ </span><span>AIåˆ†æ</span></a>
    <a class="nav-item" href="/orders.html"><span class="icon">ğŸ“‹</span><span>äº¤æ˜“è®°å½•</span></a>
    <a class="nav-item" href="/audit.html"><span class="icon">ğŸ”</span><span>å®¡è®¡æ—¥å¿—</span></a>
    <a class="nav-item" href="/monitor.html"><span class="icon">ğŸ–¥ï¸</span><span>ç³»ç»Ÿç›‘æ§</span></a>
    <a class="nav-item" href="/settings.html"><span class="icon">âš™ï¸</span><span>ç³»ç»Ÿé…ç½®</span></a>
  </div>
  <div class="sidebar-footer">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <span id="mode-badge">--</span>
      <button class="btn btn-sm btn-secondary" onclick="logout()">é€€å‡º</button>
    </div>
  </div>
</nav>

<!-- ä¸»å†…å®¹ -->
<main class="main-content">
  <div class="page-header">
    <div>
      <div class="page-title">ç³»ç»Ÿä»ªè¡¨ç›˜</div>
      <div class="page-subtitle" id="last-update">åŠ è½½ä¸­...</div>
    </div>
    <button class="btn btn-secondary" onclick="loadDashboard()">ğŸ”„ åˆ·æ–°</button>
  </div>

  <!-- ç³»ç»ŸçŠ¶æ€å¡ç‰‡ -->
  <div class="grid grid-4" style="margin-bottom:20px;">
    <div class="stat-card">
      <div class="stat-label">ç³»ç»Ÿå¥åº·è¯„åˆ†</div>
      <div class="stat-value" id="health-score" style="color:var(--accent-green)">--</div>
      <div class="progress"><div class="progress-bar" id="health-bar" style="width:0%"></div></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">è¿è¡Œæ¨¡å¼</div>
      <div class="stat-value" style="font-size:18px;" id="run-mode">--</div>
      <div class="stat-change" id="uptime">è¿è¡Œæ—¶é•¿: --</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ä»Šæ—¥åˆ†ææ¬¡æ•°</div>
      <div class="stat-value" id="analysis-count">--</div>
      <div class="stat-change up" id="analysis-cost">é¢„ä¼°æˆæœ¬: --</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ä»Šæ—¥äº¤æ˜“æ¬¡æ•°</div>
      <div class="stat-value" id="order-count">--</div>
      <div class="stat-change" id="order-rate">æˆåŠŸç‡: --</div>
    </div>
  </div>

  <!-- ä»·æ ¼å¡ç‰‡ -->
  <div class="card" style="margin-bottom:16px;">
    <div class="card-title">å®æ—¶è¡Œæƒ…</div>
    <div class="grid grid-3">
      <div id="price-BTC" class="stat-card">
        <div class="stat-label">BTC/USDT</div>
        <div class="stat-value" style="color:var(--accent-yellow)">--</div>
        <div class="stat-change">ä¿¡å·: <span class="badge badge-gray">--</span></div>
      </div>
      <div id="price-ETH" class="stat-card">
        <div class="stat-label">ETH/USDT</div>
        <div class="stat-value" style="color:var(--accent-blue)">--</div>
        <div class="stat-change">ä¿¡å·: <span class="badge badge-gray">--</span></div>
      </div>
      <div id="price-SOL" class="stat-card">
        <div class="stat-label">SOL/USDT</div>
        <div class="stat-value" style="color:var(--accent-green)">--</div>
        <div class="stat-change">ä¿¡å·: <span class="badge badge-gray">--</span></div>
      </div>
    </div>
  </div>

  <div class="grid grid-2">
    <!-- AI æœ€æ–°åˆ†æ -->
    <div class="card">
      <div class="card-title">æœ€æ–° AI åˆ†æä¿¡å·</div>
      <div id="signals-list"><div class="loading">åŠ è½½ä¸­...</div></div>
    </div>

    <!-- ç³»ç»Ÿå‘Šè­¦ -->
    <div class="card">
      <div class="card-title">ç³»ç»Ÿå‘Šè­¦</div>
      <div id="alerts-list"><div class="loading">åŠ è½½ä¸­...</div></div>
    </div>
  </div>

  <!-- å·¨é²¸åŠ¨å‘ -->
  <div class="card">
    <div class="card-title">ğŸ‹ å·¨é²¸åŠ¨å‘æ‘˜è¦</div>
    <div id="whale-summary"><div class="loading">åŠ è½½ä¸­...</div></div>
  </div>
</main>

<script src="/js/app.js"></script>
<script>
const startTime = Date.now();

async function loadDashboard() {
  try {
    const data = await apiFetch('/api/dashboard');
    if (!data) return;

    // ç³»ç»ŸçŠ¶æ€
    const score = data.health?.score || 0;
    document.getElementById('health-score').textContent = score;
    const bar = document.getElementById('health-bar');
    bar.style.width = score + '%';
    bar.className = 'progress-bar' + (score < 50 ? ' red' : score < 80 ? ' yellow' : '');
    document.getElementById('run-mode').textContent = modeLabel(data.health?.mode);
    document.getElementById('last-update').textContent = 'æœ€åæ›´æ–°: ' + fmt.time(data.timestamp);
    document.getElementById('mode-badge').innerHTML = `<span class="badge ${score > 80 ? 'badge-green' : score > 50 ? 'badge-yellow' : 'badge-red'}">${modeLabel(data.health?.mode)}</span>`;

    // ç»Ÿè®¡
    document.getElementById('analysis-count').textContent = fmt.number(data.stats?.analysisToday || 0);
    document.getElementById('analysis-cost').textContent = 'é¢„ä¼°æˆæœ¬: $' + (data.stats?.costToday || 0).toFixed(4);
    document.getElementById('order-count').textContent = fmt.number(data.stats?.ordersToday || 0);
    document.getElementById('order-rate').textContent = 'æˆåŠŸç‡: ' + fmt.pct(data.stats?.orderSuccessRate);

    // ä»·æ ¼
    const prices = data.prices || {};
    ['BTC', 'ETH', 'SOL'].forEach(coin => {
      const p = prices[coin + '-USDT'] || {};
      const el = document.getElementById('price-' + coin);
      if (el) {
        el.querySelector('.stat-value').textContent = fmt.price(p.price);
        const action = (data.signals || {})[coin + '-USDT']?.action || 'hold';
        el.querySelector('.stat-change').innerHTML = `ä¿¡å·: <span class="badge ${actionBadge[action]}">${actionLabel[action] || action}</span>`;
      }
    });

    // AI ä¿¡å·åˆ—è¡¨
    const signals = data.signals || {};
    const signalHtml = Object.entries(signals).map(([coin, s]) => `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border-color);">
        <div>
          <span style="font-weight:600;">${coin}</span>
          <span class="badge ${actionBadge[s.action] || 'badge-gray'}" style="margin-left:8px;">${actionLabel[s.action] || s.action}</span>
        </div>
        <div style="text-align:right;font-size:12px;color:var(--text-secondary);">
          ç½®ä¿¡åº¦ ${fmt.pct(s.confidence)} | ${s.consensus_type === '3_unanimous' ? '3ç¥¨ä¸€è‡´' : s.consensus_type === '2_majority' ? '2ç¥¨å¤šæ•°' : 'åˆ†æ­§'}
        </div>
      </div>
    `).join('') || '<div style="color:var(--text-secondary);font-size:13px;">æš‚æ— ä¿¡å·</div>';
    document.getElementById('signals-list').innerHTML = signalHtml;

    // å‘Šè­¦
    const alerts = data.alerts || [];
    const alertHtml = alerts.length > 0 ? alerts.slice(0, 5).map(a => `
      <div class="alert-item alert-${a.level || 'info'}">
        <div>
          <div class="alert-text">${a.message}</div>
          <div class="alert-time">${fmt.time(a.timestamp)}</div>
        </div>
      </div>
    `).join('') : '<div style="color:var(--text-secondary);font-size:13px;padding:10px 0;">æš‚æ— å‘Šè­¦ âœ“</div>';
    document.getElementById('alerts-list').innerHTML = alertHtml;

    // å·¨é²¸
    const whale = data.whale || {};
    document.getElementById('whale-summary').innerHTML = `
      <div class="grid grid-3">
        ${['BTC-USDT','ETH-USDT','SOL-USDT'].map(coin => {
          const w = whale[coin] || {};
          return `<div class="stat-card">
            <div class="stat-label">${coin}</div>
            <div style="font-size:20px;font-weight:700;margin:6px 0;">${w.score || '--'}</div>
            <div style="font-size:12px;color:var(--text-secondary);">${w.score > 70 ? 'ğŸ‹ åå¤š' : w.score > 50 ? 'âš–ï¸ ä¸­æ€§' : w.score ? 'ğŸ» åç©º' : 'æ•°æ®ä¸è¶³'}</div>
          </div>`;
        }).join('')}
      </div>`;
  } catch (e) {
    console.error('Dashboard load error:', e);
  }
}

function modeLabel(m) {
  return { normal: 'æ­£å¸¸', degraded: 'é™çº§', emergency: 'ç´§æ€¥' }[m] || m || '--';
}

// æ›´æ–°è¿è¡Œæ—¶é•¿
setInterval(() => {
  const s = Math.floor((Date.now() - startTime) / 1000);
  const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60);
  document.getElementById('uptime').textContent = `è¿è¡Œæ—¶é•¿: ${h}æ—¶${m}åˆ†`;
}, 1000);

loadDashboard();
setInterval(loadDashboard, 30000);
</script>
</body>
</html>
